input {
  beats {
	port => 5044 
	type => sonicwall
	}
}



filter {

    grok {
        match => [ "message", "^%{SYSLOG5424PRI}%{SPACE}%{GREEDYDATA:message2}" ]
    }

    mutate {
        rename => { "message2" => "message" }
        remove_field => [ "message2" ]
    }

    mutate {
        add_field => { "sagaSN" => ["18B169A3A748", "2CB8ED362088", "18B169B67A44", "18B16909E7F0",
       "2CB8ED3C03A8", "18B1690C4A34", "18B16909E5B0", "18B169D2288C",
       "18B1690A43AC", "18B169B69544", "18B169D3F7B8", "18B169D2435C",
       "18B1690BCC7C", "18B169B6526C", "18B169D3A52C", "18B1690C2748",
       "18B169B669A0", "18B169D213B0", "2CB8ED3BFD00", "18B1690C4824"]}
        add_field => { "picapauSN" => ["18B169374A50", "18B1693733E0", "18B169372DD0", "2CB8ED124E40",
       "18B1693B7D40", "18B169375220", "18B1693751D0"]}
        add_field => { "medcomSN" => ["18B169AECAEC", "18B169E36028", "18B169E35FE0", "18B169B0892C",
       "18B1699EDCB4", "18B1699E8AA0", "2CB8ED11CBC0"]}
        add_field => { "kingSN" => ["18B16928BDEC", "C0EAE48FEE0A", "18B169615D50", "18B169A0F980",
       "18B169616368"]}
        add_field =>{ "vgshSN" => ["18B1690C3828"]}
        add_field => {"grupovbSN" => ["18B169614880", "2CB8ED36B7C0"]}
        add_field => {"isoesteSN" => ["C0EAE48FEE0A"]}
        add_field => {"inSN" => ["18B16917F484"]}
        add_field => {"grupotsSN" => ["18B169D83380", "18B169D887C0", "18B169E51DFC"]}
        add_field => {"citSN" => ["2CB8ED422928"]}
        add_field => {"frgnt2SN" => ["18B1693448C8"]}
        add_field => {"jcfarmaSN" => ["18B16939FDA0", "18B16939FD50"]}
    }
  
    # Remove fields from the kv filter that you do not want to index
    kv {
        exclude_keys => [ "c", "m", "n", "pri","type" ]
    }

    # src & dst usually come as <IP>:<PORT>:<INTERFACE>.  This separates them.
    if ("tcp" in [proto]){
        if (":" in [src]){
            grok {
                match => [ "src", "^%{IP:srcip}:%{INT:srcport}:%{GREEDYDATA:srcint}" ]
                remove_field => ["src"]
            }
          }
        if (":" in [dst]) {
            grok {
                match => [ "dst", "^%{IP:dstip}:%{INT:dstport}:%{GREEDYDATA:dstint}" ]
                remove_field => [ "dst"]
            }
        }
    } else if ("udp" in [proto]){
        if (":" in [src]){
            grok {
                match => [ "src", "^%{IP:srcip}:%{INT:srcport}" ]
                remove_field => ["src"]
            }
          }
        if (":" in [dst]) {
            grok {
                match => [ "dst", "^%{IP:dstip}:%{INT:dstport}" ]
                remove_field => [ "dst"]
            }
        }
    } else if "ospfigp" in [proto] {
        if (":" in [src]) {
            grok {
                match => [ "src", "^%{IP:srcip}:%{INT:srcport}:%{GREEDYDATA:srcint}" ]
                remove_field => ["src"]
            }
          }
        if (":" in [dst]) {
            grok {
                match => [ "dst", "^%{IP:dstip}:%{INT:dstport}" ]
                remove_field => [ "dst"]
            }
        }
    } else if [proto] == "icmp" {
        if (":" in [src]){
            grok {
                match => [ "src", "^%{IP:srcip}::%{GREEDYDATA:srcint}" ]
                remove_field => ["src"]
            }
          }
        if (":" in [dst]) {
            grok {
                match => [ "dst", "^%{IP:dstip}" ]
                remove_field => [ "dst"]
            }
        }
    } else if [msg] == "Received notify. NO_PROPOSAL_CHOSEN" {
        if (":" in [src]){
            grok {
                match => [ "src", "^%{IP:srcip}:%{INT:srcport}" ]
                remove_field => ["src"]
            }
          }
        if (":" in [dst]) {
            grok {
                match => [ "dst", "^%{IP:dstip}:%{INT:dstport}" ]
                remove_field => [ "dst"]
            }
        }
    } else if [proto] == "0" {
        mutate {
            add_field => { "srcip" => "0.0.0.0" }
            add_tag => [ "private" ]
        }
    } 

    #  Do not geoip private IPs
    
    geoip {
        source => "srcip"
        }

    mutate {
	remove_field => ["message"]}
    
    if [sn] in [sagaSN] {
      mutate { 
        add_tag => "SAGA"
        remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
        "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [picapauSN] {
      mutate { 
          add_tag => "PICAPAU"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [medcomSN] {
      mutate { 
          add_tag => "MEDCOM"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [kingSN] {
      mutate { 
          add_tag => "KINGSPANISOESTE"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }
    
    else if [sn] in [vgshSN] {
      mutate { 
          add_tag => "VGSH"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }
 
    else if [sn] in [grupotsSN] {
      mutate { 
          add_tag => "GRUPOVB"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [isoesteSN] {
      mutate { 
          add_tag => "ISOESTE"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [inSN] {
      mutate { 
          add_tag => "IN"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [grupotsSN] {
      mutate { 
          add_tag => "GRUPOTS"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if  [sn] in [citSN] {
      mutate { 
          add_tag => "CIT"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }

    else if [sn] in [frgnt2SN] {
      mutate { 
          add_tag => "FRGNT2"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }
 
    else if [sn] in [jcfarmaSN] {
      mutate { 
          add_tag => "JCFARMA"
          remove_field => ["sagaSN", "picapauSN", "medcomSN", "kingSN",
          "vgshSN", "grupovbSN", "isoesteSN", "inSN", "grupotsSN", "citSN","frgnt2SN","jcfarmaSN"] }
    }
 
}

output {
	elasticsearch {
		hosts => ["elasticsearch:9200"]
		user => "elastic"
		password => "elastic"
		index => "compacted-sonicwall-%{+YYYY.MM.dd}"	
	}
	stdout { codec => rubydebug }
}
